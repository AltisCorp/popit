<%= render(
  'html_head.html',
  {
    title:       'API',
    description: 'The API allows you to easily access all the data stored in PopIt from your code or other websites.',
  }
) %>


<h1>API</h1>

<p>The API allows you to easily access and edit all the data stored in PopIt from your code or other websites.</p>

<h2> Getting Started</h2>

<p>
  The API returns  
  <a href="http://en.wikipedia.org/wiki/JSON">JSON</a>
  - a data format that is easily usable in all programming languages. It is possible to view JSON in your browser (and easily follow embedded links) if you have one of the following extensions installed:
</p>

<ul>

  <li>
    <a href="https://chrome.google.com/webstore/detail/chklaanhfefbnpoihckbnefhakgolnmc">JSONView</a>
    for Chrome
  </li>
  
  <li>
    <a href="https://addons.mozilla.org/en-US/firefox/addon/jsonview/">JSONView</a>
    for FireFox
  </li>
  
  <li>
    <a href="http://stackoverflow.com/questions/2483771/how-can-i-convince-ie-to-simply-display-application-json-rather-than-offer-to-do">Not sure it can be done easily</a>
    for Internet Explorer :(
  </li>
  
  <li>
    Try a search for "JSON Viewer &lt;your browser name&gt;" for other browsers.
  </li>

</ul>

<p> 
  You can now <a href="/api/v1"> enter the API</a> and click around to navigate.
</p>


<h2>Basics</h2>

<p>
  The API is based on 
  <a href="http://en.wikipedia.org/wiki/Representational_state_transfer">REST</a>
</p>


<h3>Bindings</h3>

<p>
  There are libraries available that make the API easy to use in the following languages:
</p>

<ul>
  <li>
    <strong>PHP:</strong> 
    <a href="https://github.com/mysociety/popit-php">
      https://github.com/mysociety/popit-php
    </a>
  </li>
  
  <li>
    <strong>Python:</strong>
    <a href="https://github.com/mysociety/popit-python">
      https://github.com/mysociety/popit-python
    </a>
  </li>

  <li>
    <strong>Ruby:</strong>
    <a href="https://github.com/opennorth/popit-ruby">
      https://github.com/opennorth/popit-ruby
    </a>
  </li>
</ul>
  
<p>
  | The API is REST based and simple to use. 
  | For other languages 
  a(href="https://github.com/mysociety/popit/blob/master/docs/contributing.md") contributions
  |  are very welcome.
</p>


<h3>API Versions</h3>

<p>
  There is a version string in the API url. This will be updated if the API undergoes siginificant changes that breaks backwards compatability. Old APIs will be supported for a bit, but will eventually be deprecated. Hopefully version changes will be very rare.
</p>

<p>
  <b>NOTE</b> until PopIt is considered stable the API will change and the 'v1' version will break. Please contact us if you need to know which parts of the API are stable.
</p>


<h3>result / results</h3>

<p>
  When you make a query the returned data will always be a hash. There will be a result or results key that contains the data you've requested.
</p>


<h3>meta</h3>

<p>
  When you make requests to the API you'll often get little 'meta' blocks in the results. These blocks are added to the data by the API to provide additional information that may be helpful. For example it might contain links to the API endpoint for a result in a search, or a link to the web page where you can edit the data.
</p>

<p>
  The meta blocks are also used to provide next and previous links in list results (not implemented yet).
</p>


<h3>errors</h3>

<p>
  If something goes wrong there will be an 'error' or 'errors' key that will explain the error. Often an HTTP error code will also be used (eg '404' if a result cannot be found).
</p>


<h3>ObjectIds and slugs</h3>

<p>
  Objects in PopIt are always identified in the API by their ObjectId - which is generated by the database and is a 24 character hex string.
</p>

<p>
  As a conveniance you can also look up objects using their slug. If found the request will be redirected to the correct ObjectId based query. This is so that you can use the slugs in URLs on your site and easily retrieve data without having to store the corresponding ObjectIds locally.
</p>

<pre>
      by ObjectId:  /api/v1/person/4f99219333fa2efc68000006
      by slug:      /api/v1/person/joe-bloggs
</pre>

<p>
  Note that slugs may change so your links may break. ObjectIds will never change.
</p>


<h3>Searching</h3>

<p>
  Currently only simple searching implemented - you can search by ObjectIds and by case-insensitive string matching. Examples:
</p>

<pre>
      /api/v1/person?name=joe
      /api/v1/position?person=4f99219333fa2efc68000006
</pre>

<p>
  Better searching (exact matches, gte, etc) is on the TODO list.
</p>


<h3>JSONP</h3>

<p>
  Read (GET) requests to the API can have an optional <tt>callback</tt> parameter 
  which will cause 
  <a href="http://en.wikipedia.org/wiki/JSONP">JSONP</a>
  to be returned. This might be useful if querying the API from a browser 
  on another website.
</p>


<h3>Auth</h3>

<p>
  For write operations on the API you need to be authenticated. This can 
  either be done using 
  <a href="http://en.wikipedia.org/wiki/Basic_access_authentication">Basic Authentication</a>
  or by cookie auth. Basic is probably best for scripts and pragramatic 
  access, cookie based for Ajax calls etc.
</p>

<p> 
  We will probably need to add token based auth 
  <a href="https://github.com/mysociety/popit/issues/113">(#113)</a>
  in the future, as well as adding CSRF protection 
  <a href="https://github.com/mysociety/popit/issues/112">(#112)</a>.
  Tickets have been created for these in the issue tracker.
</p>

<h3>Images</h3>

<p>
  If a document has images associated with it they will be in the results. 
  In the meta for the image will be a url that can be used to retrieve the 
  image - either from our server (if the image was uploaded) or from the URL 
  that was stored.
</p>

<p>
  This url is of the raw image that was uploaded. If you need it in a 
  different size you should use the built in image proxy to resize and 
  convert the image as required. Note that this will only work for images 
  served from the same domain as the image proxy, so it will not work for 
  images hosted elsewhere.
</p>

<p>
  The base url to the image proxy is given in the meta on the 
  <a href="/api/v1">API entry page</a>. 
  Documentation on how to use the proxy is available on the 
  <a href="https://github.com/mysociety/node-connect-image-proxy">proxy code's GitHub page</a>.
</p>

<%= render('html_footer.html' )%>
